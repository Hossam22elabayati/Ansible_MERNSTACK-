---
# tasks file for roles/common
- name: Update all Packages 
  ansible.builtin.apt: 
    name: "*"
    state: latest 
    update_cache: yes
- name: install common packages 
  ansible.builtin.apt:
    pkg: "{{ common_packages }}"
    state: present 
- name: Generate local key pair 
  community.crypto.openssh_keypair:
    path: "{{ item.key }}"
  loop: "{{ users }}"
  delegate_to: localhost 
  become: false 

- name: Add users group  
  ansible.builtin.group: 
    name: "{{ item.group }}"
    state: "{{ item.state  }}" 
  loop: "{{ users }}"
- name: Add users 
  ansible.builtin.user: 
    name: "{{ item.name }}"
    group: "{{ item.group  }}"
    comment: " {{ item.name }}  "
    state: "{{ item.state }}" 
  loop: "{{ users  }}"

- name: add keys to our users 
  ansible.posix.authorized_key: 
    user: "{{ item.name }}" 
    key: "{{ lookup('file', item.key + '.pub') }}"
  loop: "{{ users }}"
